---
title: "02_script_for_plots"
output: html_document
date: "2024-01-10"
---

# Left join für Plots 

```{r }
BDIxCESD <- left_join(SUBSET_BDI, SUBSET_CESD, by = c("Study", "Variable")) %>%
  filter(complete.cases(BDI, CESD))

BDIxHADS <- left_join(SUBSET_BDI, SUBSET_HADS, by = c("Study", "Variable")) %>%
  filter(complete.cases(BDI, HADS))

BDIxPHQ <- left_join(SUBSET_BDI, SUBSET_PHQ, by = c("Study", "Variable")) %>%
  filter(complete.cases(BDI, PHQ))

BDIxPROMIS <- left_join(SUBSET_BDI, SUBSET_PROMIS, by = c("Study", "Variable")) %>%
  filter(complete.cases(BDI, PROMIS))

CESDxHADS <- left_join(SUBSET_CESD, SUBSET_HADS, by = c("Study", "Variable")) %>%
  filter(complete.cases(CESD, HADS))

CESDxPHQ <- left_join(SUBSET_CESD, SUBSET_PHQ, by = c("Study", "Variable")) %>%
  filter(complete.cases(CESD, PHQ))

CESDxPROMIS <- left_join(SUBSET_CESD, SUBSET_PROMIS, by = c("Study", "Variable")) %>%
  filter(complete.cases(CESD, PROMIS))

HADSxPHQ <- left_join(SUBSET_HADS, SUBSET_PHQ, by = c("Study", "Variable")) %>%
  filter(complete.cases(HADS, PHQ))

HADSxPROMIS <- left_join(SUBSET_HADS, SUBSET_PROMIS, by = c("Study", "Variable")) %>%
  filter(complete.cases(HADS, PROMIS))

PHQxPROMIS <- left_join(SUBSET_PHQ, SUBSET_PROMIS, by = c("Study", "Variable")) %>%
  filter(complete.cases(PHQ, PROMIS))

```

# Vorbereitung Plot mit facets: Datensatz benennen und Fragebogenkombination als Spalte hinzufügen

```{r }

BDIxCESD_short <- BDIxCESD %>%
  mutate(`Wert 1` = `BDI - PROMIS Skala`,
         `Wert 2` = `CESD - PROMIS Skala`,
         `Fragebogenkombination` = "BDIxCESD")

BDIxHADS_short <- BDIxHADS %>%
  mutate(`Wert 1` = `BDI - PROMIS Skala`,
         `Wert 2` = `HADS - PROMIS Skala`,
         `Fragebogenkombination` = "BDIxHADS")

BDIxPHQ_short <- BDIxPHQ %>%
  mutate(`Wert 1` = `BDI - PROMIS Skala`,
         `Wert 2` = `PHQ - PROMIS Skala`,
         `Fragebogenkombination` = "BDIxPHQ")

BDIxPROMIS_short <- BDIxPROMIS %>%
  mutate(`Wert 1` = `BDI - PROMIS Skala`,
         `Wert 2` = `PROMIS`,
         `Fragebogenkombination` = "BDIxPROMIS")

CESDxHADS_short <- CESDxHADS %>%
  mutate(`Wert 1` = `CESD - PROMIS Skala`,
         `Wert 2` = `HADS - PROMIS Skala`,
         `Fragebogenkombination` = "CESDxHADS")

CESDxPHQ_short  <- CESDxPHQ %>%
  mutate(`Wert 1` = `CESD - PROMIS Skala`,
         `Wert 2` = `PHQ - PROMIS Skala`,
         `Fragebogenkombination` = "CESDxPHQ")

CESDxPROMIS_short  <- CESDxPROMIS %>%
  mutate(`Wert 1` = `CESD - PROMIS Skala`,
         `Wert 2` = `PROMIS`,
         `Fragebogenkombination` = "CESDxPROMIS")

HADSxPHQ_short  <- HADSxPHQ %>%
  mutate(`Wert 1` = `HADS - PROMIS Skala`,
         `Wert 2` = `PHQ - PROMIS Skala`,
         `Fragebogenkombination` = "HADSxPHQ")

HADSxPROMIS_short <- HADSxPROMIS %>%
  mutate(`Wert 1` = `HADS - PROMIS Skala`,
         `Wert 2` = `PROMIS`,
         `Fragebogenkombination` = "HADSxPROMIS")

PHQxPROMIS_short <- PHQxPROMIS %>%
  mutate(`Wert 1` = `PHQ - PROMIS Skala`,
         `Wert 2` = `PROMIS`,
         `Fragebogenkombination` = "PHQxPROMIS")

```



# Scatterplots einzeln über alle Fragebogenkombinationen
```{r }
library(ggplot2)
#install.packages("hrbrthemes")
library(hrbrthemes)

# BDIxCESD
BDIxCESD$groupsize.y <- as.numeric(as.character(BDIxCESD$groupsize.y)) 
BDIxCESD_plot<- ggplot(BDIxCESD, aes(x = `BDI - PROMIS Skala`, y = `CESD - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +  # Hier wird der Name der Punktgröße geändert
  theme_ipsum()


# BDIxHADS
BDIxHADS$groupsize.y <- as.numeric(as.character(BDIxHADS$groupsize.y))  
BDIxHADS_plot<- ggplot(BDIxHADS, aes(x = `BDI - PROMIS Skala`, y = `HADS - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +  # Hier wird der Name der Punktgröße geändert
  theme_ipsum()
  
  
#BDIxPHQ
BDIxPHQ$groupsize.y <- as.numeric(as.character(BDIxPHQ$groupsize.y))  
BDIxPHQ_plot<- ggplot(BDIxPHQ, aes(x = `BDI - PROMIS Skala`, y = `PHQ - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") + 
  theme_ipsum()


# BDIxPROMIS
BDIxPROMIS$groupsize.y <- as.numeric(as.character(BDIxPROMIS$groupsize.y))  
BDIxPROMIS_plot <- ggplot(BDIxPROMIS, aes(x = `BDI - PROMIS Skala`, y = `PROMIS`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +  
  theme_ipsum()


#CESDxHADS
CESDxHADS$groupsize.y <- as.numeric(as.character(CESDxHADS$groupsize.y))  
CESDxHADS_plot <- ggplot(CESDxHADS, aes(x = `CESD - PROMIS Skala`, y = `HADS - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +
  theme_ipsum()


#CESDxPHQ
CESDxPHQ$groupsize.y <- as.numeric(as.character(CESDxPHQ$groupsize.y))  
CESDxPHQ_plot <- ggplot(CESDxPHQ, aes(x = `CESD - PROMIS Skala`, y = `PHQ - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +
  theme_ipsum()


#PHQxPROMIS
PHQxPROMIS$groupsize.y <- as.numeric(as.character(PHQxPROMIS$groupsize.y))  
PHQxPROMIS_plot <- ggplot(PHQxPROMIS, aes(x = `PHQ - PROMIS Skala`, y = `PROMIS`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +
  theme_ipsum()

#HADSxPHQ
HADSxPHQ$groupsize.y <- as.numeric(as.character(HADSxPHQ$groupsize.y))  
HADSxPHQ_plot <- ggplot(HADSxPHQ, aes(x = `HADS - PROMIS Skala`, y = `PHQ - PROMIS Skala`)) + 
  geom_point(aes(size = groupsize.y)) +
  geom_smooth(method = "lm", color = "red", fill = "#69b3a2", se = TRUE) +
  xlim(40, 90) +
  ylim(40, 90) +
  labs(size = "Gruppengröße") +
  theme_ipsum()
  

```



# einen facetted Plot plotten 

```{r}

# dafür hab ich händisch eine Tabelle erstellt

dat_short <- read_excel("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/2023/CPCOR/Git/MetaanalysisCommonMetrics/01_data/dat_short.xlsx", 
    skip = 1)

dat_short <- dat_short %>%
  rename(Wert_1 = "Wert 1")

dat_short <- dat_short %>%
  rename(Wert_2 = "Wert 2")

p<- ggplot (data=dat_short, aes_string(x='Wert_2', y= 'Wert_1')) + geom_point(aes(size = Groupsize))
p+facet_wrap(~Fragebogenkombination)


# design

library(ggplot2)

p <- ggplot(data = dat_short, aes(x = Wert_2, y = Wert_1)) +
  geom_point(aes(size = Groupsize, color = ifelse(is.na(Groupsize), "blue", "black"))) +
  geom_smooth(method = "lm", color = "red", size = 0.5, fill = "#69b3a2", se = TRUE) +
  labs(size = "Gruppengröße") +
  scale_size_continuous(range = c(0, 5), breaks = seq(10, 3700, by = 1000)) +
  scale_color_identity()

# Print the plot
print(p)

Scatterplots <- p+facet_wrap(~Fragebogenkombination)

# Save the plot as a PNG file
ggsave("Scatterplots.png", Scatterplots, width = 10, height = 6, units = "in")



```



# Blant Altman Plot einzeln 

```{r }
# Mittelwertlinie gewichten 

if (!require(blandr)) {
  install.packages("blandr")
  library(blandr)
}


BDIxCESD_BA_plot <- blandr.draw(BDIxCESD$'BDI - PROMIS Skala', BDIxCESD$'CESD - PROMIS Skala')
BDIxCESD_BA_plot <- BDIxCESD_BA_plot +
  geom_point(size = 1) +  # Adjust the size parameter to make points smaller +
  theme(text = element_text(size = 6)) +
  labs(title = "BDIxCESD") +
  xlim(40, 80) +
  ylim(-15, 25)


# BDIxHADS
BDIxHADS_BA_plot <- blandr.draw(BDIxHADS$'BDI - PROMIS Skala', BDIxHADS$'HADS - PROMIS Skala')
BDIxHADS_BA_plot <- BDIxHADS_BA_plot +
  theme(text = element_text(size = 6)) +
  labs(title = "BDIxHADS") +
  xlim(40, 80) +
  ylim(-15, 25)



# BDIxPHQ

BDIxPHQ_BA_plot <- blandr.draw(BDIxPHQ$'BDI - PROMIS Skala', BDIxPHQ$'PHQ - PROMIS Skala') +
  theme(text = element_text(size = 6)) +
  labs(title = "BDIxPHQ") +
  xlim(40, 80) +
  ylim(-15, 25)



# BDIxPROMIS

BDIxPROMIS_BA_plot <- blandr.draw(BDIxPROMIS$'BDI - PROMIS Skala', BDIxPROMIS$'PROMIS') +
  theme(text = element_text(size = 6)) +
  labs(title = "BDIxPROMIS") +
  xlim(40, 80) +
  ylim(-15, 25)





# CESDxHADS

CESDxHADS_BA_plot <- blandr.draw(CESDxHADS$'CESD - PROMIS Skala', CESDxHADS$'HADS - PROMIS Skala') +
  theme(text = element_text(size = 6)) +
  labs(title = "CESDxHADS") +
  xlim(40, 80) +
  ylim(-15, 25)



# CESDxPHQ

CESDxPHQ_BA_plot <- blandr.draw(CESDxPHQ$'CESD - PROMIS Skala', CESDxPHQ$'PHQ - PROMIS Skala') +
  theme(text = element_text(size = 6)) +
  labs(title = "CESDxPHQ") +
  xlim(40, 80) +
  ylim(-15, 25)




# CESDxPROMIS

CESDxPROMIS_BA_plot <- blandr.draw(CESDxPROMIS$'CESD - PROMIS Skala', CESDxPROMIS$'PROMIS') +
  theme(text = element_text(size = 6)) +
  labs(title = "CESDxPROMIS") +
  xlim(40, 80) +
  ylim(-15, 25)



# HADSxPHQ  

HADSxPHQ_BA_plot <- blandr.draw(
  HADSxPHQ$'HADS - PROMIS Skala', 
  HADSxPHQ$'PHQ - PROMIS Skala'
) +
  theme(text = element_text(size = 6)) +
  labs(title = "HADSxPHQ") +
  xlim(40, 80) +
  ylim(-15, 25)



# PHQxPROMIS

PHQxPROMIS_BA_plot <- blandr.draw(
  PHQxPROMIS$'PHQ - PROMIS Skala',
  PHQxPROMIS$'PROMIS'
) +
  theme(text = element_text(size = 6)) +
  labs(title = "PHQxPROMIS") +
  xlim(40, 80) +
  ylim(-15, 25)



```

weighted Bland Altman Plot

```{r }

method1 <- PHQxPROMIS$'PHQ - PROMIS Skala'
method2 <- PHQxPROMIS$'PROMIS'
group_sizes <- PHQxPROMIS$'groupsize.x'
group_sizes <- as.numeric(group_sizes)
# Gewichtete Differenzen berechnen

weighted_diff <- (method2 - method1) * group_sizes
weighted_diff<- as.numeric(weighted_diff)

# Gewichteter Durchschnitt der Differenzen berechnen
weighted_mean_diff <- sum(weighted_diff) / sum(as.numeric(group_sizes))


group_sizes <- as.numeric(group_sizes)


# Gewichteter arithmetischer Mittelwert berechnen
weighted_mean_values <- weighted.mean(cbind(method1, method2), rep(group_sizes, each = 2))


# Bland-Altman-Plot erstellen
library(BlandAltmanLeh)
bland_altman <- bland.altman.plot(method1, method2, xlab = "Mittelwert", ylab = "Differenz",
                                  main = "Bland-Altman Plot", col = "blue", pch = 16)

# Hinzufügen des gewichteten Mittelwerts als Linie
abline(h = weighted_mean_values, col = "red", lty = 2)

# ggplot2-Anpassungen
library(ggplot2)
library(ggpubr)

# ggplot2-Objekt erstellen
bland_altman_gg <- ggplot(as.data.frame(bland_altman$Data), aes(x = weighted_mean_values, y = weighted_diff)) +
  geom_point(aes(color = group_sizes), size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", size = 0.5) +
  geom_smooth(method = "loess", se = FALSE, color = "blue", size = 0.7) +
  labs(title = "PHQxPROMIS", x = "Mittelwert", y = "Differenz") +
  theme_pubr() +
  theme(text = element_text(size = 6)) +
  xlim(40, 80) +
  ylim(-15, 25)  

# Anzeigen des kombinierten Plots
print(bland_altman_gg)






```

# Blant Altman Plot alle
```{r }
library(gridExtra)

Blant_plot<- suppressWarnings({
  BDIxCESD_BA_plot <- blandr.draw(BDIxCESD$'BDI - PROMIS Skala', BDIxCESD$'CESD - PROMIS Skala')
  BDIxCESD_BA_plot <- BDIxCESD_BA_plot +
    geom_point(size = 0.1) +
    scale_size(range = c(0.1, 1.0)) +  # Adjust the range to control the size scaling factor
    theme(text = element_text(size = 6)) +
    
    labs(title = "BDIxCESD") +
    xlim(40, 80) +
    ylim(-15, 25)

  BDIxHADS_BA_plot 
  BDIxPHQ_BA_plot
  CESDxHADS_BA_plot 
  CESDxPHQ_BA_plot
  PHQxPROMIS_BA_plot
  HADSxPHQ_BA_plot 

  grid.arrange(BDIxCESD_BA_plot, BDIxHADS_BA_plot, BDIxPHQ_BA_plot, CESDxHADS_BA_plot, CESDxPHQ_BA_plot, PHQxPROMIS_BA_plot,HADSxPHQ_BA_plot, nrow = 2)
})

ggsave("Blant_plot.png", Blant_plot, width = 10, height = 6, units = "in")


```
